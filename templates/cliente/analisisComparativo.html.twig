{% extends 'base.html.twig' %}

{% block title %}Análisis Comparativo{% endblock %}

{% block stylesheets %}
<style>
    .content-wrapper, .main-header{
        margin-left: 0 !important;
    }
</style>
{% endblock %}

{% block sidebar %}

{% endblock %}


{% block body %}


    <div class="card shadow">
        <div class="card-header">
            <div class="row" style="display: flex; justify-content: space-between; align-items: center">
                <h3 class="card-title text-bold text-gray">Análisis Comparativo</h3>
            </div>
        </div>
        <!-- /.card-header -->
        <div class="card-body">
            <form id="formFilterDash" method="post">
                <div class="row">
                    <div class="col-12 col-sm-6 col-md-3 col-lg-3 col-xl-3 form-group">
                        <label for="plan">Plan<span class="text-danger">*</span></label>
                        <select class="form-control" id="plan" name="plan" required>
                            <option value="">Seleccione</option>
                            {% for plan in planes %}
                                <option value="{{ plan.id }}" {% if planFilter == plan.id %} selected {% endif %}>{{ plan.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-12 col-sm-6 col-md-3 col-lg-3 col-xl-3 form-group">
                        <label for="municipio">Indicadores<span class="text-danger">*</span></label>
                        <select class="form-control" id="indicadores" name="indicadores[]" multiple required>

                        </select>
                    </div>
                    <div class="col-12 col-sm-6 col-md-3 col-lg-3 col-xl-3 form-group">
                        <label for="municipio">Municipios<span class="text-danger">*</span></label>
                        <select class="form-control" id="municipio" name="municipio[]" multiple required>

                        </select>
                    </div>
                    <div class="col-12 col-sm-6 col-md-3 col-lg-3 col-xl-3 form-group">
                        <label for="municipio">Mes a comparar<span class="text-danger">*</span></label>
                        <select class="form-control" id="planMensual" name="planMensual" required>
                            <option value="">Seleccione</option>
                            {% for mes in meses %}
                                <option value="{{ mes }}" {% if planMensualFilter == mes %} selected {% endif %}>{{ mes }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-12 mb-2">
                        <button type="submit" class="btn btn-primary float-right">Comparar</button>
                    </div>

                </div>

            </form>
            <div class="row">
                {% for item in data %}
                    <div class="col-12 col-sm-6 col-md-4 col-lg-4 col-xl-3" style="padding: 0; padding-left: 1px">
                        <div class="card" style="border-radius: 0; margin-bottom: 2px;">
                            <div class="card-header border-transparent bg-light" style="border-radius: 0">
                                <h3 class="card-title">{{ item['municipio'] }}</h3>

                                <div class="card-tools">
                                    <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                </div>
                            </div>
                            <!-- /.card-header -->
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table m-0">
                                        <thead>
                                        <tr class="bg-light">
                                            <th>Indicador</th>
                                            <th>Real ejecutado</th>
                                            <th>Cumplimiento</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        {% for indicador in item['indicadores'] %}
                                            <tr>
                                                <td>{{ indicador['nombre'] }}</td>
                                                <td class="text-center" style="color: {{ indicador['color'] }}">{{ indicador['datos']['planReal']|default('0') }}</td>
                                                <td class="text-center" style="color: {{ indicador['color'] }}">{{ indicador['evaluacion'] }}</td>
                                            </tr>
                                        {% endfor %}

                                        </tbody>
                                    </table>
                                </div>
                                <!-- /.table-responsive -->
                            </div>

                        </div>
                    </div>

                {% endfor %}


            </div>
        </div>
        <!-- /.card-body -->
    </div>



{% endblock %}
{% block javascripts %}
    <script>

        $(document).ready(function () {
            if ($('#plan').val() != "") {
                HoldOn.open({
                    theme: "sk-cube-grid",
                    message: 'Por favor espere...',
                    textColor: "white"
                });

                var url1 = "{{ path('app_analisis_comparativo_indicadores', {'id':'idP'}) }}";
                url = url1.replace('idP', $('#plan').val());
                $.get(url, function (data) {

                    $('#indicadores option').remove();
                    let indicadoresF = JSON.parse('{{ indicadoresFilter | raw }}');
                    for (var i = 0; i < data.indicadoresS.length; i++) {

                        if (indicadoresF.find(e => e.toString() == data.indicadoresS[i].indicador_id.toString())) {
                            var $newOption = $("<option selected='selected'></option>").val(data.indicadoresS[i].indicador_id).text(data.indicadoresS[i].indicador_nombre)
                        } else {
                            var $newOption = $("<option ></option>").val(data.indicadoresS[i].indicador_id).text(data.indicadoresS[i].indicador_nombre)
                        }


                        $("#indicadores").append($newOption);
                    }

                    if ($('#indicadores').val() != "") {

                        var url1 = "{{ path('app_analisis_comparativo_indicadores_change', {'id':'idP', 'indicadores' : 'indiC'}) }}";
                        url = url1.replace('idP', $('#plan').val());
                        url = url.replace('indiC', $('#indicadores').val());
                        $.get(url, function (data) {
                            $('#municipio option').remove();

                            let municipiosF = JSON.parse('{{ municipioFilter | raw }}');
                            for (var i = 0; i < data.length; i++) {

                                if (municipiosF.find(e => e.toString() == data[i].id.toString())) {
                                    var $newOption = $("<option selected='selected'></option>").val(data[i].id).text(data[i].nombre)
                                } else {
                                    var $newOption = $("<option ></option>").val(data[i].id).text(data[i].nombre)
                                }


                                $("#municipio").append($newOption).trigger('change');
                                // $('#municipio').append(new Option(data.municipiosS[i].nombre, data.municipiosS[i].id, true, true));
                            }
                            HoldOn.close()
                        });
                    }
                });
            }


        })
        $('#plan').on('change', function () {
            if ($(this).val() != "") {
                HoldOn.open({
                    theme: "sk-cube-grid",
                    message: 'Por favor espere...',
                    textColor: "white"
                });
                var url1 = "{{ path('app_analisis_comparativo_indicadores', {'id':'idP'}) }}";
                url = url1.replace('idP', $(this).val());
                $.get(url, function (data) {

                    $('#indicadores option').remove();
                    for (var i = 0; i < data.indicadoresS.length; i++) {
                        $('#indicadores').append(new Option(data.indicadoresS[i].indicador_nombre, data.indicadoresS[i].indicador_id));
                    }

                    // $('#municipio option').remove();
                    // for (var i = 0; i < data.municipiosS.length; i++) {
                    //     $('#municipio').append(new Option(data.municipiosS[i].nombre, data.municipiosS[i].id));
                    // }
                    HoldOn.close()
                });
            }
        });

        $('#indicadores').on('change', function () {
            console.log('change');
            if ($(this).val() != "") {
                HoldOn.open({
                    theme: "sk-cube-grid",
                    message: 'Por favor espere...',
                    textColor: "white"
                });
                var url1 = "{{ path('app_analisis_comparativo_indicadores_change', {'id':'idP', 'indicadores' : 'indiC'}) }}";
                url = url1.replace('idP', $('#plan').val());
                url = url.replace('indiC', $(this).val());
                $.get(url, function (data) {


                    $('#municipio option').remove();
                    for (var i = 0; i < data.length; i++) {
                        $('#municipio').append(new Option(data[i].nombre, data[i].id));
                    }
                    HoldOn.close()
                });
            }
        });
        $('.menuAmburguesa').remove()
    </script>
{% endblock %}